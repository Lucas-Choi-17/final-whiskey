<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="reportManagement">

        <!-- 신고 유형 선택 탭 -->
        <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="restaurant-tab" data-bs-toggle="tab" data-bs-target="#restaurant"
                    type="button" role="tab" aria-controls="restaurant" aria-selected="true">식당 신고</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button"
                    role="tab" aria-controls="review" aria-selected="false">리뷰 신고</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comment-tab" data-bs-toggle="tab" data-bs-target="#comment" type="button"
                    role="tab" aria-controls="comment" aria-selected="false">댓글 신고</button>
            </li>
        </ul>

        <!-- 신고 목록 및 상세 정보 -->
        <div class="tab-content" id="reportTabContent">
            <!-- 식당 신고 -->
            <div class="tab-pane fade show active" id="restaurant" role="tabpanel" aria-labelledby="restaurant-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">식당 신고 목록</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>신고 번호</th>
                                                <th>대상 식당</th>
                                                <th>신고 제목</th>
                                                <th id="reportDate">신고 날짜</th>
                                                <th>처리 여부</th>
                                            </tr>
                                        </thead>
                                        <tbody id="restaurantReportList">
                                            <!-- 식당 신고 목록이 여기에 동적으로 추가됩니다 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="pagination">
                                    <button class="pagebtn" id="pre">◀</button>
                                    <button class="pagebtn" id="back">▶</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">식당 신고 상세 정보</h5>
                                <div id="restaurantReportDetail">
                                    <!-- 선택된 식당 신고의 상세 정보가 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 리뷰 신고 -->
            <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">리뷰 신고 목록</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>신고 번호</th>
                                                <th>리뷰 제목</th>
                                                <th>신고 제목</th>
                                                <th id="reviewReportDate">신고 날짜</th>
                                                <th>처리 여부</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reviewReportList">
                                            <!-- 리뷰 신고 목록이 여기에 동적으로 추가됩니다 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="pagination">
                                    <button class="pagebtn" id="reviewPre">◀</button>
                                    <button class="pagebtn" id="reviewBack">▶</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">리뷰 신고 상세 정보</h5>
                                <div id="reviewReportDetail">
                                    <!-- 선택된 리뷰 신고의 상세 정보가 여기에 표시됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 댓글 신고 -->
            <div class="tab-pane fade" id="comment" role="tabpanel" aria-labelledby="comment-tab">
                <!-- TODO: 댓글 신고 관련 내용 추가 -->
            </div>
        </div>
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function () {
                let currentSortOrder = 'asc';
                let currentPage = 0;
                let reviewCurrentSortOrder = 'asc';
                let reviewCurrentPage = 0;

                fetchRestaurantReports(currentPage, currentSortOrder);

                function fetchRestaurantReports(page, sortOrder = 'asc') {
                    $.ajax({
                        url: /*[[@{/restaurantreport/list}]]*/ '/restaurantreport/list',
                        data: { page: page, sortOrder: sortOrder },
                        type: 'GET',
                        success: function (data) {
                            let tableBody = $('#restaurantReportList');
                            tableBody.empty();
                            if (data && data.content && data.content.length > 0) {
                                data.content.forEach(function (report) {
                                    let formattedDate = new Date(report.reportedAt).toLocaleDateString();
                                    let row = `
                                          <tr data-id="${report.id}">
                                              <td>${report.id}</td>
                                              <td>${report.restaurant ? report.restaurant.name : 'N/A'}</td>
                                              <td>${report.title}</td>
                                              <td>${formattedDate}</td>
                                              <td>${report.checked ? '처리 완료' : '처리 전'}</td>
                                          </tr>
                                      `;
                                    tableBody.append(row);
                                });
                                updatePaginationControls(data.number, data.totalPages);
                            } else {
                                tableBody.append('<tr><td colspan="5">신고된 식당이 없습니다.</td></tr>');
                            }
                        },
                        error: function (xhr, status, error) {
                            $('#restaurantReportList').html('<tr><td colspan="5">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>');
                        }
                    });
                }

                // 페이지네이션 컨트롤 업데이트
                function updatePaginationControls(currentPage, totalPages) {
                    $('#pre').prop('disabled', currentPage === 0);
                    $('#back').prop('disabled', currentPage === totalPages - 1);
                }

                // 식당 신고 상세 정보 로드
                function loadRestaurantReportDetail(reportId) {
                    $.ajax({
                        url: `/restaurantreport/detail/${reportId}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            let report = data.report;
                            let detailHtml = `
                                <h6>신고 번호: <span id="reportId">${report.id}</span></h6>
                                <p>식당 이름: <span id="restaurantTitle">${report.restaurant.name}</span></p>
                                <p>제목: <span id="title">${report.title}</span></p>
                                <p>내용: <span id="content">${report.content}</span></p>
                                <p>신고일: <span id="reportedAt">${new Date(report.reportedAt).toLocaleDateString()}</span></p>
                                <p>처리여부: <span id="checked">${report.checked ? '처리완료' : '처리 전'}</span></p>
                                <button type="button" class="btn btn-danger" id="punish">처벌</button>
                                <button type="button" class="btn btn-warning" id="pass">보류</button>
                            `;
                            $('#restaurantReportDetail').html(detailHtml);
                        }
                    });
                }

                // 신고 처리 함수
                function updateReport(reportId, btnId) {
                    if (confirm("신고처리를 진행하시겠습니까?")) {
                        $.ajax({
                            url: `/restaurantreport/update/${reportId}`,
                            type: "PUT",
                            data: { btnId: btnId },
                            success: function () {
                                alert('신고처리 되었습니다.');
                                fetchRestaurantReports(currentPage, currentSortOrder);
                                loadRestaurantReportDetail(reportId);
                            },
                            error: function () {
                                alert('신고처리에 실패했습니다.');
                            }
                        });
                    }
                }

                // 이벤트 리스너들
                $(document).on('click', '#restaurantReportList tr', function () {
                    let reportId = $(this).data('id');
                    loadRestaurantReportDetail(reportId);
                });

                $(document).on('click', '#reportDate', function () {
                    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    fetchRestaurantReports(currentPage, currentSortOrder);
                });

                $(document).on('click', '#pre', function () {
                    if (currentPage > 0) {
                        currentPage--;
                        fetchRestaurantReports(currentPage, currentSortOrder);
                    }
                });

                $(document).on('click', '#back', function () {
                    currentPage++;
                    fetchRestaurantReports(currentPage, currentSortOrder);
                });

                $(document).on('click', '#punish, #pass', function () {
                    let btnId = $(this).attr('id');
                    let reportId = $('#reportId').text();
                    updateReport(reportId, btnId);
                });

                function fetchReviewReports(page, sortOrder = 'asc') {
                    $.ajax({
                        url: /*[[@{/reviewreport/list}]]*/ '/reviewreport/list',
                        data: { page: page, sortOrder: sortOrder },
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            console.log('Review reports data:', data); // 로그 추가
                            let tableBody = $('#reviewReportList');
                            tableBody.empty();
                            if (data && data.content && data.content.length > 0) {
                                data.content.forEach(function (report) {
                                    let formattedDate = new Date(report.reportedAt).toLocaleDateString();
                                    let row = `
                                        <tr data-id="${report.id}">
                                            <td>${report.id}</td>
                                            <td>${report.review ? report.review.title : 'N/A'}</td>
                                            <td>${report.title}</td>
                                            <td>${formattedDate}</td>
                                            <td>${report.checked ? '처리 완료' : '처리 전'}</td>
                                        </tr>
                                    `;
                                    tableBody.append(row);
                                });
                                updateReviewPaginationControls(data.number, data.totalPages);
                            } else {
                                console.log('No review reports found'); // 로그 추가
                                tableBody.append('<tr><td colspan="5">신고된 리뷰가 없습니다.</td></tr>');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching review reports:', error);
                            console.error('XHR status:', status);
                            console.error('XHR response:', xhr.responseText);
                            $('#reviewReportList').html('<tr><td colspan="5">데이터를 불러오는 중 오류가 발생했습니다. 자세한 내용은 콘솔을 확인해주세요.</td></tr>');
                        }
                    });
                }

                function updateReviewPaginationControls(currentPage, totalPages) {
                    $('#reviewPre').prop('disabled', currentPage === 0);
                    $('#reviewBack').prop('disabled', currentPage === totalPages - 1);
                }

                function loadReviewReportDetail(reportId) {
                    if (reportId === undefined || reportId === null) {
                        console.error('Invalid reportId');
                        return;
                    }

                    $.ajax({
                        url: `/reviewreport/detail/${reportId}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            let report = data.report;
                            let detailHtml = `
                                  <h6>신고 번호: <span id="reviewReportId">${report.id}</span></h6>
                                  <p>리뷰 제목: <span id="reviewTitle">${report.review.title}</span></p>
                                  <p>신고 제목: <span id="reviewReportTitle">${report.title}</span></p>
                                  <p>신고 내용: <span id="reviewReportContent">${report.content}</span></p>
                                  <p>신고일: <span id="reviewReportedAt">${new Date(report.reportedAt).toLocaleDateString()}</span></p>
                                  <p>처리여부: <span id="reviewReportChecked">${report.checked ? '처리완료' : '처리 전'}</span></p>
                                  <button type="button" class="btn btn-danger" id="reviewPunish">처벌</button>
                                  <button type="button" class="btn btn-warning" id="reviewPass">보류</button>
                              `;
                            $('#reviewReportDetail').html(detailHtml);
                        },
                        error: function (xhr, status, error) {
                            console.error('Error loading report detail:', error);
                            $('#reviewReportDetail').html('<p>데이터를 불러오는 중 오류가 발생했습니다.</p>');
                        }
                    });
                }

                function updateReviewReport(reportId, btnId) {
                    if (confirm("리뷰 신고처리를 진행하시겠습니까?")) {
                        $.ajax({
                            url: `/reviewreport/update/${reportId}`,
                            type: "PUT",
                            data: { btnId: btnId },
                            success: function () {
                                alert('리뷰 신고처리가 완료되었습니다.');
                                fetchReviewReports(reviewCurrentPage, reviewCurrentSortOrder);
                                loadReviewReportDetail(reportId);
                            },
                            error: function () {
                                alert('리뷰 신고처리에 실패했습니다.');
                            }
                        });
                    }
                }

                // 이벤트 리스너들
                $(document).on('click', '#reviewReportList tr', function () {
                    let reportId = $(this).data('id');
                    loadReviewReportDetail(reportId);
                });

                $(document).on('click', '#reviewReportDate', function () {
                    reviewCurrentSortOrder = reviewCurrentSortOrder === 'asc' ? 'desc' : 'asc';
                    fetchReviewReports(reviewCurrentPage, reviewCurrentSortOrder);
                });

                $(document).on('click', '#reviewPre', function () {
                    if (reviewCurrentPage > 0) {
                        reviewCurrentPage--;
                        fetchReviewReports(reviewCurrentPage, reviewCurrentSortOrder);
                    }
                });

                $(document).on('click', '#reviewBack', function () {
                    reviewCurrentPage++;
                    fetchReviewReports(reviewCurrentPage, reviewCurrentSortOrder);
                });

                $(document).on('click', '#reviewPunish, #reviewPass', function () {
                    let btnId = $(this).attr('id');
                    let reportId = $('#reviewReportId').text();
                    updateReviewReport(reportId, btnId);
                });

                // 초기 리뷰 신고 목록 로드
                $('#review-tab').on('shown.bs.tab', function (e) {
                    fetchReviewReports(reviewCurrentPage, reviewCurrentSortOrder);
                });
            });
            /*]]>*/
        </script>
</div>
</body>
</html>